<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Trazabilidad y Síntesis de Secuestros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'inst-dark': '#111827',
                        'inst-light': '#F9FAFB',
                        'inst-text-dark': '#D1D5DB',
                        'inst-text-light': '#374151',
                        'accent': {
                            '50': '#f0f9ff',
                            '100': '#e0f2fe',
                            '200': '#bae6fd',
                            '300': '#7dd3fc',
                            '400': '#38bdf8',
                            '500': '#0ea5e9',
                            '600': '#0284c7',
                            '700': '#0369a1',
                            '800': '#075985',
                            '900': '#0c4a6e',
                        },
                    }
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-btn {
            transition: all 0.2s ease-in-out;
            color: var(--inst-text-dark, #D1D5DB);
        }
        .sidebar-btn:hover {
            background-color: #374151; /* gray-700 */
            color: #FFFFFF;
        }
        .sidebar-btn.active {
            background-color: #0ea5e9; /* accent-500 */
            color: #FFFFFF;
            font-weight: 600;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.6);
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        /* Scrollbar styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-inst-light text-inst-text-light">

    <!-- Seccion de Login -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-sm">
            <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo Institucional" class="mx-auto mb-6 h-32 w-32 object-contain" onerror="this.src='https://placehold.co/128x128/111827/FFFFFF?text=Escudo';">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full border border-gray-200">
                <h2 class="text-2xl font-bold text-inst-dark mb-2 text-center">Control de Trazabilidad</h2>
                <p class="text-center text-gray-500 mb-6 text-sm">Inicie sesión para continuar</p>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 text-left mb-1">Usuario (DNI)</label>
                        <input type="text" id="username" name="username" required
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-accent-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 text-left mb-1">Contraseña</label>
                        <input type="password" id="password" name="password" required
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-accent-500">
                    </div>
                    <div>
                        <button type="submit"
                                class="w-full mt-2 bg-accent-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-accent-700 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:ring-opacity-50 transition-colors">
                            <span id="login-btn-text">Iniciar Sesión</span>
                            <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
                        </button>
                    </div>
                </form>
                <p id="login-error" class="text-sm text-center text-red-600 mt-4"></p>
            </div>
        </div>
    </div>


    <!-- Portal Principal -->
    <div id="main-portal" class="hidden h-screen">
        <div class="flex h-full">
            <!-- Sidebar -->
            <aside class="w-72 bg-inst-dark text-inst-text-dark p-4 flex flex-col justify-between shadow-lg">
                <div>
                     <div class="text-center mb-6 pt-2">
                        <img src="https://raw.githubusercontent.com/gutierrezruarte/BibliotecaSPC/main/Escudo-1-279x300-removebg-preview.png" alt="Escudo Institucional" class="mx-auto mb-3 h-20 w-20 object-contain" onerror="this.src='https://placehold.co/80x80/111827/FFFFFF?text=Escudo';">
                        <h1 class="text-xl font-semibold text-accent-400">Trazabilidad</h1>
                    </div>
                    <nav id="main-menu" class="space-y-2 px-2">
                        <!-- Los botones del menu se generarán dinámicamente -->
                    </nav>
                </div>
                <div class="px-2">
                    <div id="user-info" class="text-center text-sm text-gray-400 mb-4 p-2 rounded-lg bg-gray-800"></div>
                    <button id="logout-btn" class="w-full px-4 py-2 text-sm font-bold bg-red-600 rounded-lg hover:bg-red-700 transition-colors text-white">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </aside>

            <!-- Contenido Principal -->
            <main class="flex-1 p-6 md:p-8 overflow-y-auto">
                <div id="content-area">
                    <!-- El contenido dinámico se carga aquí -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal para mensajes -->
    <div id="message-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-auto border-t-4 border-accent-500">
            <h3 id="message-modal-title" class="text-xl font-semibold text-inst-dark mb-3"></h3>
            <p id="message-modal-text" class="mt-2 text-gray-600"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="px-5 py-2 bg-accent-500 text-white text-sm font-semibold rounded-lg hover:bg-accent-600">Cerrar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para confirmacion -->
    <div id="confirm-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-full mx-auto border-t-4 border-yellow-400">
            <h3 id="confirm-modal-title" class="text-xl font-semibold text-inst-dark mb-3"></h3>
            <p id="confirm-modal-text" class="mt-2 text-gray-600"></p>
            <div class="mt-6 flex justify-end space-x-3">
                 <button id="confirm-modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="confirm-modal-ok" class="px-5 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Actuaciones -->
    <div id="actuaciones-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full mx-auto border-t-4 border-accent-700">
            <h3 id="actuaciones-modal-title" class="text-xl font-semibold text-inst-dark mb-4">Cargar Actuaciones</h3>
            <form id="actuaciones-form">
                <input type="hidden" id="actuaciones-proc-id">
                <div class="space-y-4">
                    <div>
                        <label for="actuaciones-tipo" class="block text-sm font-medium text-gray-700">Tipo de Actuación</label>
                        <select id="actuaciones-tipo" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent-500 focus:border-accent-500" required>
                            <option value="">Seleccione...</option>
                            <option value="SAC">Número de SAC</option>
                            <option value="Decomiso">Acta de decomiso</option>
                            <option value="Destruccion">Acta de destrucción</option>
                        </select>
                    </div>
                    <div>
                        <label for="actuaciones-numero" class="block text-sm font-medium text-gray-700">Número / Identificador</label>
                        <input type="text" id="actuaciones-numero" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent-500 focus:border-accent-500" required>
                    </div>
                    <div id="autoridad-container" class="hidden">
                         <label for="actuaciones-autoridad" class="block text-sm font-medium text-gray-700">Autoridad Interviniente</label>
                        <input type="text" id="actuaciones-autoridad" class="mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent-500 focus:border-accent-500">
                    </div>
                    <div>
                         <label for="actuaciones-archivo" class="block text-sm font-medium text-gray-700">Adjuntar Archivo Escaneado</label>
                         <input type="file" id="actuaciones-archivo" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent-50 file:text-accent-700 hover:file:bg-accent-100">
                         <p id="actuaciones-archivo-info" class="text-xs text-gray-500 mt-1"></p>
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                     <button type="button" id="actuaciones-modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-5 py-2 bg-accent-600 text-white text-sm font-semibold rounded-lg hover:bg-accent-700">
                        <span id="actuaciones-btn-text">Guardar</span>
                        <i id="actuaciones-spinner" class="fas fa-spinner fa-spin hidden"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles del procedimiento -->
    <div id="procedure-details-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-auto border-t-4 border-accent-800 flex flex-col" style="max-height: 90vh;">
            <div class="p-5 border-b flex justify-between items-center">
                 <h3 class="text-2xl font-semibold text-inst-dark">Detalles del Procedimiento</h3>
                 <button id="details-modal-close" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                 <!-- Contenido dinámico aquí -->
                 <div id="details-content"></div>
            </div>
             <div class="p-4 bg-gray-50 border-t text-right">
                <button id="details-modal-close-btn" class="px-5 py-2 bg-accent-500 text-white text-sm font-semibold rounded-lg hover:bg-accent-600">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Usuario -->
    <div id="edit-user-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-3xl w-full mx-auto border-t-4 border-accent-700">
            <h3 class="text-xl font-semibold text-inst-dark mb-4">Editar Usuario</h3>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="edit-user-dni" class="block text-sm font-medium text-gray-700">Usuario (DNI)</label><input type="text" id="edit-user-dni" class="w-full px-3 py-2 mt-1 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                    <div><label for="edit-user-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label><input type="text" id="edit-user-name" class="w-full px-3 py-2 mt-1 bg-white border border-gray-300 rounded-lg shadow-sm" required></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="edit-user-role" class="block text-sm font-medium text-gray-700">Rol</label><select id="edit-user-role" class="w-full px-3 py-2 mt-1 bg-white border border-gray-300 rounded-lg shadow-sm" required></select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Alcances (Sectores)</label><div id="edit-user-scope" class="mt-1 p-2 border border-gray-300 rounded-lg bg-white max-h-40 overflow-y-auto grid grid-cols-2 gap-2"></div></div>
                </div>
                <div>
                    <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
                        <input type="checkbox" id="edit-user-can-delete" class="h-4 w-4 rounded border-gray-300 text-accent-600 focus:ring-accent-500">
                        <span>Puede eliminar procedimientos</span>
                    </label>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="edit-user-modal-cancel" class="px-5 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="px-5 py-2 bg-accent-600 text-white text-sm font-semibold rounded-lg hover:bg-accent-700">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, addDoc, onSnapshot, query, where, updateDoc, Timestamp, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAV5LQjFQa1ftFs1UC9hLg21Nn63eJS6k8",
            authDomain: "markitoxzz.firebaseapp.com",
            projectId: "markitoxzz",
            storageBucket: "markitoxzz.appspot.com",
            messagingSenderId: "523363280423",
            appId: "1:523363280423:web:9cf350fa1eba84ad1e1002",
            measurementId: "G-Z0RC2GN60K"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- ESTADO DE LA APLICACION ---
        let currentUser = null;
        let allProcedures = [];
        let proceduresUnsubscribe = null; // Para el listener de onSnapshot

        // --- DATOS MAESTROS (Se mantienen localmente) ---
        const ROLES = [
            'Servicio de Guardia', 'G.E.A.R.', 'Body Scanner', 'Jefe de Seguridad', 
            'Departamento Inspección', 'Departamento Seguridad', 'Organos Judiciales', 
            'Secretaría de Seguridad o Dirección', 'Director', 'Admin', 'Consultor'
        ];
        const SECTORES = ['C.C.N° 1 - MD1', 'C.C.N° 1 - M2', 'C.C.N° 1 - MAD', 'C.C.N° 1 - MX1', 'C.C.N° 1 - MX2', 'C.C.N° 2 - M1', 'C.C.N° 2 - M2', 'C.C.N° 2 - GRANJA', 'E.P.N° 3', 'E.P.N° 4', 'E.P.N° 5', 'E.P.N° 6', 'E.P.N° 7', 'E.P.N° 8', 'E.P.N° 9 - UCA'];
        const ORGANOS = ['Servicio de Guardia', 'G.E.A.R.', 'Body Scanner', 'Jefe de Seguridad'];
        const ELEMENTOS_CONFIG = {
            'Sustancias': {
                'COCAINA': [{ name: 'peso', label: 'Peso (en grs)', type: 'number', step: '0.1' }],
                'MARIHUANA': [{ name: 'peso', label: 'Peso (en grs)', type: 'number', step: '0.1' }],
                'PSICOFÁRMACOS': [{ name: 'cantidad', label: 'Cantidad (en uds)', type: 'number' }],
                'ALCOHOL': [{ name: 'cantidad', label: 'Cantidad (en lts)', type: 'number', step: '0.1' }]
            },
            'Electrónicos': {
                'CELULAR': [
                    { name: 'marca', label: 'Marca', type: 'text' }, { name: 'modelo', label: 'Modelo', type: 'text' }, { name: 'imei1', label: 'IMEI 1', type: 'text' }, { name: 'imei2', label: 'IMEI 2 (Opcional)', type: 'text' }, { name: 'tieneCamara', label: 'Tiene cámara', type: 'checkbox' }, { name: 'cantidadCamaras', label: 'Cantidad', type: 'number', dependsOn: 'tieneCamara', min: '1' }
                ],
                'CHIPS': [ { name: 'operadora', label: 'Operadora', type: 'text' }, { name: 'numeroIdentificatorio', label: 'Número identificatorio', type: 'text' } ],
                'BATERÍAS': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }], 'CARGADORES': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }], 'CABLES USB': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }], 'AURICULARES': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }], 'PLAQUETA': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }]
            },
            'Otros': { 'PUNZOCORTANTES': [{ name: 'cantidad', label: 'Cantidad', type: 'number' }], 'OTROS': [{ name: 'descripcion', label: 'Descripción', type: 'textarea' }] }
        };

        window.openDetailsModal = openDetailsModal;
        window.openActuacionesModal = openActuacionesModal;
        window.handleResetPassword = handleResetPassword;
        window.handleDeleteProcedure = handleDeleteProcedure;
        window.openEditUserModal = openEditUserModal;
        window.handleToggleUserStatus = handleToggleUserStatus;

        // --- LÓGICA DE LA APLICACIÓN ---
        
        function showMessage(title, text) {
            document.getElementById('message-modal-title').textContent = title;
            document.getElementById('message-modal-text').textContent = text;
            document.getElementById('message-modal').classList.remove('hidden');
            document.getElementById('message-modal').classList.add('flex');
        }

        document.getElementById('message-modal-close').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
            document.getElementById('message-modal').classList.remove('flex');
        });

        function showConfirm(title, text, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-text').textContent = text;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');

            const okButton = document.getElementById('confirm-modal-ok');
            const cancelButton = document.getElementById('confirm-modal-cancel');

            const close = () => {
                document.getElementById('confirm-modal').classList.add('hidden');
                document.getElementById('confirm-modal').classList.remove('flex');
                okButton.replaceWith(okButton.cloneNode(true));
            };
            
            okButton.onclick = () => { onConfirm(); close(); };
            cancelButton.onclick = close;
        }
        
        function toggleSpinner(buttonId, show) {
            const text = document.getElementById(`${buttonId}-text`);
            const spinner = document.getElementById(`${buttonId}-spinner`);
            if (text && spinner) {
                text.classList.toggle('hidden', show);
                spinner.classList.toggle('hidden', !show);
                spinner.parentElement.disabled = show;
            }
        }
        
        // --- AUTENTICACIÓN Y SESIÓN ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists() && userDoc.data().active) {
                    currentUser = { id: user.uid, email: user.email, ...userDoc.data() };
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    if(document.getElementById('login-section').classList.contains('hidden')) {
                        showPortal(); // Refresh portal if already logged in
                    } else {
                        showPortal();
                    }
                } else {
                    if (userDoc.exists() && !userDoc.data().active) {
                        console.log('Login attempt by inactive user:', user.email);
                    }
                    await handleLogout();
                }
            } else {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                showLogin();
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            toggleSpinner('login-btn', true);
            const dni = e.target.username.value;
            const password = e.target.password.value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            
            const email = `${dni}@trazabilidad.app`;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Chequeo inmediato del estado del usuario en Firestore
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (!userDoc.exists() || !userDoc.data().active) {
                    await signOut(auth); // Desloguear si no está activo o no existe en DB
                    errorP.textContent = 'Su usuario está desactivado o no tiene un perfil. Contacte al administrador.';
                }
                // Si todo está bien, onAuthStateChanged se encargará del resto.

            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                if (error.code === 'auth/invalid-credential') {
                    errorP.textContent = 'Usuario o contraseña incorrectos. Verifique los datos.';
                } else {
                    errorP.textContent = 'Ocurrió un error inesperado. Intente nuevamente.';
                }
            } finally {
                toggleSpinner('login-btn', false);
            }
        }

        async function handleLogout() {
            if (proceduresUnsubscribe) {
                proceduresUnsubscribe();
                proceduresUnsubscribe = null;
            }
            await signOut(auth);
        }

        function showLogin() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('main-portal').classList.add('hidden');
        }

        function showPortal() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-portal').classList.remove('hidden');
            if (!currentUser) return;
            document.getElementById('user-info').innerHTML = `
                <p class="font-semibold text-white">${currentUser.name}</p>
                <p class="text-xs text-gray-300">${currentUser.role}</p>
            `;
            setupMenu();
            listenToProcedures();
            navigateTo('welcome');
        }
        
        // --- NAVEGACIÓN Y RENDERIZADO ---

        function setupMenu() {
            const menu = document.getElementById('main-menu');
            menu.innerHTML = '';
            const canLoad = ['Servicio de Guardia', 'G.E.A.R.', 'Body Scanner', 'Jefe de Seguridad', 'Admin'].includes(currentUser.role);
            const menuItems = [
                { id: 'load-procedure', text: 'Cargar Nuevo Procedimiento', icon: 'fa-plus-circle', visible: canLoad },
                { id: 'summary', text: 'Resumen de Secuestros', icon: 'fa-clipboard-list', visible: true },
                { id: 'quantitative', text: 'Cuantitativas', icon: 'fa-chart-pie', visible: true },
                { id: 'admin-users', text: 'Administrar Usuarios', icon: 'fa-users-cog', visible: currentUser.role === 'Admin' }
            ];
            menuItems.forEach(item => {
                if (item.visible) {
                    const button = document.createElement('button');
                    button.id = `btn-${item.id}`;
                    button.className = 'w-full text-left px-4 py-2.5 rounded-lg sidebar-btn text-sm';
                    button.innerHTML = `<i class="fas ${item.icon} w-6 mr-2"></i> ${item.text}`;
                    button.onclick = () => navigateTo(item.id);
                    menu.appendChild(button);
                }
            });
        }
        
        function navigateTo(viewId) {
            document.querySelectorAll('#main-menu button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${viewId}`);
            if(activeBtn) activeBtn.classList.add('active');
            const contentArea = document.getElementById('content-area');
            const welcomeView = `<div id="welcome-message" class="text-center"><h2 class="text-4xl font-bold text-accent-600">Bienvenido al Portal</h2><p class="mt-4 text-lg text-gray-600">Seleccione una opción del menú para comenzar.</p></div>`;
            switch (viewId) {
                case 'welcome': contentArea.innerHTML = welcomeView; break;
                case 'load-procedure': renderLoadProcedureForm(contentArea); break;
                case 'summary': renderSummaryView(contentArea); break;
                case 'quantitative': renderQuantitativeView(contentArea); break;
                case 'admin-users': renderAdminUsersView(contentArea); break;
                default: contentArea.innerHTML = welcomeView;
            }
        }
        
        // --- LÓGICA DE PROCEDIMIENTOS ---

        function listenToProcedures() {
            if (proceduresUnsubscribe) proceduresUnsubscribe();
            const q = query(collection(db, "procedures"), orderBy("createdAt", "desc"));
            proceduresUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allProcedures = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), datetime: doc.data().datetime.toDate(), createdAt: doc.data().createdAt.toDate() }));
                if (document.getElementById('summary-table-body')) {
                    loadAndDisplaySummaryData(getCurrentSummaryFilters());
                }
            }, (error) => {
                console.error("Error escuchando procedimientos:", error);
                showMessage("Error de Conexión", "No se pudo obtener la lista de procedimientos en tiempo real.");
            });
        }
        
        async function handleSaveProcedure(e) {
            e.preventDefault();
            if (currentUser.role === 'Consultor') {
                showMessage('Acceso Denegado', 'Su rol no tiene permisos para cargar datos.');
                return;
            }
            const form = e.target;
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Guardando...`;
            const tempItems = JSON.parse(form.dataset.tempItems || '[]');
            if (tempItems.length === 0) {
                showMessage('Error', 'Debe añadir al menos un elemento secuestrado.');
                submitButton.disabled = false;
                submitButton.innerHTML = 'Guardar Procedimiento';
                return;
            }
            try {
                const tipoSecuestro = form.querySelector('input[name="tipoSecuestro"]:checked').value;
                const responsableData = getResponsableData(form);
                if (tipoSecuestro === 'CON RESPONSABLE' && (!responsableData || !responsableData.tipo)) {
                    throw new Error('Debe seleccionar un tipo de responsable.');
                }
                let organo = form.querySelector('#proc-organo').value;
                if (organo === 'otros') organo = form.querySelector('#proc-organo-otro').value.trim();
                const dateValue = form.querySelector('#proc-datetime').value;
                const procedureData = { datetime: Timestamp.fromDate(new Date(dateValue)), sector: form.querySelector('#proc-sector').value, organo, tipoSecuestro, responsable: responsableData, items: tempItems, createdBy: currentUser.id, createdByName: currentUser.name, createdAt: Timestamp.now(), actuaciones: null };
                await addDoc(collection(db, "procedures"), procedureData);
                showMessage('Éxito', 'Procedimiento guardado correctamente.');
                navigateTo('load-procedure');
            } catch (error) {
                console.error("Error guardando procedimiento:", error);
                showMessage('Error', `No se pudo guardar el procedimiento. ${error.message}`);
                submitButton.disabled = false;
                submitButton.innerHTML = 'Guardar Procedimiento';
            }
        }

        async function handleSaveActuaciones(e) {
            e.preventDefault();
            if (currentUser.role === 'Consultor') {
                showMessage('Acceso Denegado', 'Su rol no tiene permisos para modificar datos.');
                return;
            }
            toggleSpinner('actuaciones', true);
            const procId = document.getElementById('actuaciones-proc-id').value;
            const file = document.getElementById('actuaciones-archivo').files[0];
            try {
                const procRef = doc(db, "procedures", procId);
                const procDoc = await getDoc(procRef);
                const currentProc = procDoc.data();
                let actuacionesData = currentProc.actuaciones || {};
                actuacionesData.tipo = document.getElementById('actuaciones-tipo').value;
                actuacionesData.numero = document.getElementById('actuaciones-numero').value;
                actuacionesData.autoridad = document.getElementById('actuaciones-tipo').value === 'SAC' ? document.getElementById('actuaciones-autoridad').value : '';
                if (file) {
                    const storageRef = ref(storage, `actuaciones/${procId}/${file.name}`);
                    await uploadBytes(storageRef, file);
                    actuacionesData.fileURL = await getDownloadURL(storageRef);
                    actuacionesData.fileName = file.name;
                }
                await updateDoc(procRef, { actuaciones: actuacionesData });
                document.getElementById('actuaciones-modal').classList.add('hidden');
                showMessage('Éxito', 'Actuaciones actualizadas correctamente.');
            } catch (error) {
                console.error("Error guardando actuaciones: ", error);
                if (error.code === 'storage/unauthorized') {
                    showMessage("Error de Permisos", "No se pudo subir el archivo. Verifique las reglas de seguridad de Firebase Storage.");
                } else {
                    showMessage("Error", "No se pudieron guardar las actuaciones.");
                }
            } finally {
                toggleSpinner('actuaciones', false);
            }
        }
        
        async function handleDeleteProcedure(procId) {
            const proc = allProcedures.find(p => p.id === procId);
            if (!proc) return;

            showConfirm(
                'Confirmar Eliminación',
                `¿Está seguro de que desea eliminar permanentemente este procedimiento del ${proc.datetime.toLocaleDateString('es-AR')}? Esta acción no se puede deshacer.`,
                async () => {
                    try {
                        // Delete file from Storage first, if it exists
                        if (proc.actuaciones && proc.actuaciones.fileName) {
                            const fileRef = ref(storage, `actuaciones/${procId}/${proc.actuaciones.fileName}`);
                            await deleteObject(fileRef);
                        }
                        // Then delete the document from Firestore
                        await deleteDoc(doc(db, "procedures", procId));
                        showMessage('Éxito', 'El procedimiento ha sido eliminado.');
                        // The onSnapshot listener will automatically refresh the table
                    } catch (error) {
                        console.error("Error eliminando procedimiento:", error);
                        showMessage("Error", "No se pudo eliminar el procedimiento. Verifique los permisos y la conexión.");
                    }
                }
            );
        }

        function renderLoadProcedureForm(container) {
            const commonInputClasses = "w-full px-4 py-2 mt-1 bg-white border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-accent-500";

            container.innerHTML = `
                <h2 class="text-3xl font-bold text-inst-dark mb-6">Cargar Nuevo Procedimiento</h2>
                <form id="procedure-form" class="space-y-8" data-temp-items="[]">
                    <div class="p-6 bg-white rounded-xl shadow-lg border">
                        <h3 class="text-xl font-semibold text-accent-600 mb-4 border-b pb-3">1. Detalles del Hecho</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div><label class="block text-sm font-medium text-gray-700">Fecha</label><input type="date" id="proc-datetime" class="${commonInputClasses}" value="${new Date().toISOString().slice(0, 10)}" required></div>
                            <div><label class="block text-sm font-medium text-gray-700">Sector / Lugar</label><select id="proc-sector" class="${commonInputClasses}" required>${currentUser.scope.map(s => `<option value="${s}">${s}</option>`).join('')}</select></div>
                            <div><label class="block text-sm font-medium text-gray-700">Órgano que realiza</label><select id="proc-organo" class="${commonInputClasses}" required>${ORGANOS.map(o => `<option value="${o}">${o}</option>`).join('')}<option value="otros">Otros</option></select><input type="text" id="proc-organo-otro" class="hidden mt-2 ${commonInputClasses}" placeholder="Especifique otro órgano"></div>
                            <div><label class="block text-sm font-medium text-gray-700">Tipo de Secuestro</label><div class="mt-2 space-x-6"><label class="inline-flex items-center"><input type="radio" name="tipoSecuestro" value="CON RESPONSABLE" class="text-accent-600 focus:ring-accent-500"> <span class="ml-2">Con Responsable</span></label><label class="inline-flex items-center"><input type="radio" name="tipoSecuestro" value="SIN RESPONSABLE" class="text-accent-600 focus:ring-accent-500" checked> <span class="ml-2">Sin Responsable</span></label></div></div>
                        </div>
                        <div id="responsable-details" class="mt-6"><div><label for="sin-responsable-obs" class="block text-sm font-medium text-gray-700">Observaciones (Hallazgo sin responsable)</label><textarea id="sin-responsable-obs" name="sin-responsable-obs" class="${commonInputClasses}" rows="3" placeholder="Aclaraciones sobre el hallazgo..."></textarea></div></div>
                    </div>
                    <div class="p-6 bg-white rounded-xl shadow-lg border">
                        <h3 class="text-xl font-semibold text-accent-600 mb-4 border-b pb-3">2. Elementos Secuestrados</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                            <div class="space-y-4">
                                <div><label class="block text-sm font-medium text-gray-700">Tipo de Elemento</label><select id="item-type" class="${commonInputClasses}"><option value="">Seleccione...</option>${Object.keys(ELEMENTOS_CONFIG).map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Elemento Específico</label><select id="item-subtype" class="${commonInputClasses}" disabled></select></div>
                                <div id="item-specific-fields" class="space-y-4 border-t pt-4"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Observaciones del Elemento</label><textarea id="item-observaciones" class="${commonInputClasses}" rows="3"></textarea></div>
                                <button type="button" id="add-item-btn" class="px-4 py-2 font-bold text-white bg-accent-600 rounded-lg hover:bg-accent-700"><i class="fas fa-plus mr-2"></i>Añadir Elemento</button>
                            </div>
                            <div class="h-full"><h4 class="font-semibold text-gray-700 mb-2">Síntesis en Tiempo Real</h4><div id="live-synthesis" class="p-4 bg-gray-50 rounded-lg h-80 overflow-y-auto text-sm text-gray-600 border">Aún no se han añadido elementos a este procedimiento.</div></div>
                        </div>
                    </div>
                    <div class="text-right"><button type="submit" class="px-6 py-3 font-bold text-lg text-white bg-green-600 rounded-lg hover:bg-green-700"><i class="fas fa-save mr-2"></i>Guardar Procedimiento</button></div>
                </form>
            `;
            setupProcedureFormListeners();
        }
        
        function setupProcedureFormListeners() {
            const form = document.getElementById('procedure-form');
            if (!form) return;

            const commonInputClasses = "w-full px-3 py-2 mt-1 bg-white border border-gray-300 rounded-lg";
            
            form.querySelector('#proc-organo').addEventListener('change', e => {
                form.querySelector('#proc-organo-otro').classList.toggle('hidden', e.target.value !== 'otros');
            });
            form.querySelectorAll('input[name="tipoSecuestro"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    const detailsDiv = document.getElementById('responsable-details');
                    if (e.target.value === 'CON RESPONSABLE') {
                        detailsDiv.innerHTML = `<label class="block text-sm font-medium text-gray-700">Tipo de Responsable</label><div class="mt-2 space-x-6"><label class="inline-flex items-center"><input type="radio" name="tipoResponsable" value="interno" class="text-accent-600 focus:ring-accent-500"> <span class="ml-2">Interno</span></label><label class="inline-flex items-center"><input type="radio" name="tipoResponsable" value="visita" class="text-accent-600 focus:ring-accent-500"> <span class="ml-2">Visita</span></label><label class="inline-flex items-center"><input type="radio" name="tipoResponsable" value="agente" class="text-accent-600 focus:ring-accent-500"> <span class="ml-2">Agente</span></label></div><div id="responsable-specific-fields" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>`;
                        setupResponsableTypeListeners();
                    } else {
                        detailsDiv.innerHTML = `<div><label for="sin-responsable-obs" class="block text-sm font-medium text-gray-700">Observaciones (Hallazgo sin responsable)</label><textarea id="sin-responsable-obs" name="sin-responsable-obs" class="${commonInputClasses}" rows="3" placeholder="Aclaraciones sobre el hallazgo..."></textarea></div>`;
                    }
                });
            });

            const itemTypeSelect = form.querySelector('#item-type');
            const itemSubtypeSelect = form.querySelector('#item-subtype');
            const specificFieldsDiv = form.querySelector('#item-specific-fields');
            
            itemTypeSelect.addEventListener('change', () => {
                const type = itemTypeSelect.value;
                itemSubtypeSelect.innerHTML = '<option value="">Seleccione...</option>';
                specificFieldsDiv.innerHTML = '';
                itemSubtypeSelect.disabled = true;
                if (type && ELEMENTOS_CONFIG[type]) {
                    Object.keys(ELEMENTOS_CONFIG[type]).forEach(subtype => { itemSubtypeSelect.innerHTML += `<option value="${subtype}">${subtype}</option>`; });
                    itemSubtypeSelect.disabled = false;
                }
            });
            itemSubtypeSelect.addEventListener('change', () => {
                const type = itemTypeSelect.value;
                const subtype = itemSubtypeSelect.value;
                specificFieldsDiv.innerHTML = '';
                if (type && subtype && ELEMENTOS_CONFIG[type][subtype]) {
                    ELEMENTOS_CONFIG[type][subtype].forEach(field => {
                        let inputHtml = '';
                        const inputClasses = "mt-1 block w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-accent-500 focus:border-accent-500";
                        const divClass = field.dependsOn ? `hidden` : '';
                        if (field.type === 'textarea') { inputHtml = `<textarea id="field-${field.name}" name="${field.name}" class="${inputClasses}" rows="3"></textarea>`;
                        } else if (field.type === 'checkbox') { inputHtml = `<div class="flex items-center mt-2"><input id="field-${field.name}" name="${field.name}" type="checkbox" class="h-4 w-4 text-accent-600 focus:ring-accent-500 border-gray-300 rounded"></div>`;
                        } else { inputHtml = `<input id="field-${field.name}" name="${field.name}" type="${field.type}" ${field.step ? `step="${field.step}"` : ''} ${field.min ? `min="${field.min}"` : ''} class="${inputClasses}">`; }
                        specificFieldsDiv.innerHTML += `<div id="container-field-${field.name}" class="${divClass}"><label for="field-${field.name}" class="block text-sm font-medium text-gray-700">${field.label}</label>${inputHtml}</div>`;
                    });
                    const camaraCheckbox = document.getElementById('field-tieneCamara');
                    if (camaraCheckbox) { camaraCheckbox.addEventListener('change', (e) => { document.getElementById('container-field-cantidadCamaras').classList.toggle('hidden', !e.target.checked); }); }
                }
            });

            form.querySelector('#add-item-btn').addEventListener('click', () => {
                const type = itemTypeSelect.value;
                const subtype = itemSubtypeSelect.value;
                if (!type || !subtype) { showMessage('Error', 'Debe seleccionar un tipo y subtipo de elemento.'); return; }
                const newItem = { type, subtype, observaciones: document.getElementById('item-observaciones').value, details: {} };
                const fields = ELEMENTOS_CONFIG[type][subtype];
                let isValid = true;
                fields.forEach(field => {
                    const input = document.getElementById(`field-${field.name}`);
                    if(input) {
                        if (field.type === 'checkbox') { newItem.details[field.name] = input.checked;
                        } else { if (!input.closest(`div[id^="container-field-"]`).classList.contains('hidden') && input.value.trim() === '') { isValid = false; }
                            newItem.details[field.name] = input.value;
                        }
                    }
                });
                if (!isValid) { showMessage('Error', 'Por favor, complete todos los campos visibles del elemento.'); return; }
                let currentItems = JSON.parse(form.dataset.tempItems || '[]');
                currentItems.push(newItem);
                form.dataset.tempItems = JSON.stringify(currentItems);
                updateLiveSynthesis(currentItems);
                resetItemForm();
            });

            form.addEventListener('submit', handleSaveProcedure);
        }
        
        function updateLiveSynthesis(items) {
            const container = document.getElementById('live-synthesis');
            if (items.length === 0) {
                container.innerHTML = 'Aún no se han añadido elementos a este procedimiento.';
                return;
            }
            container.innerHTML = items.map((item, index) => {
                let detailsText = Object.entries(item.details)
                    .map(([key, value]) => {
                        const fieldConfig = ELEMENTOS_CONFIG[item.type][item.subtype].find(f => f.name === key);
                        if (!value) return '';
                        return `<li><strong class="font-medium text-gray-800">${fieldConfig.label}:</strong> ${value === true ? 'Sí' : value}</li>`;
                    }).join('');
                if (item.observaciones) { detailsText += `<li><strong class="font-medium text-gray-800">Observaciones:</strong> ${item.observaciones}</li>`; }
                return `<div class="mb-3 p-3 bg-white border rounded-md"><p class="font-bold text-accent-700">${index + 1}. ${item.subtype}</p><ul class="list-disc list-inside text-xs pl-2 mt-1 space-y-1">${detailsText}</ul></div>`;
            }).join('');
        }

        function resetItemForm() {
            document.getElementById('item-type').value = '';
            document.getElementById('item-subtype').innerHTML = '<option value="">Seleccione...</option>';
            document.getElementById('item-subtype').disabled = true;
            document.getElementById('item-specific-fields').innerHTML = '';
            document.getElementById('item-observaciones').value = '';
        }

        function setupResponsableTypeListeners(){
            const commonInputClasses = "w-full px-3 py-2 mt-1 bg-white border border-gray-300 rounded-lg";
             document.querySelectorAll('input[name="tipoResponsable"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    const fieldsDiv = document.getElementById('responsable-specific-fields');
                    let html = '';
                    switch(e.target.value) {
                        case 'interno': html = `<div><label class="text-sm font-medium text-gray-700">Apellido y Nombres</label><input name="resp-nombre" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Leg. n°</label><input name="resp-legajo" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Pabellón</label><input name="resp-pabellon" type="text" class="${commonInputClasses}"></div>`; break;
                        case 'visita': html = `<div><label class="text-sm font-medium text-gray-700">Apellido (Visita)</label><input name="resp-visita-apellido" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Nombre (Visita)</label><input name="resp-visita-nombre" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">DNI (Visita)</label><input name="resp-visita-dni" type="text" class="${commonInputClasses}"></div><div class="md:col-span-2 border-t pt-4 mt-2"><p class="text-sm font-semibold text-accent-700">Datos del Interno Visitado</p></div><div><label class="text-sm font-medium text-gray-700">Apellido (Interno)</label><input name="resp-interno-apellido" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Nombre (Interno)</label><input name="resp-interno-nombre" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Número de Legajo</label><input name="resp-interno-legajo" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Pabellón</label><input name="resp-interno-pabellon" type="text" class="${commonInputClasses}"></div>`; break;
                        case 'agente': html = `<div><label class="text-sm font-medium text-gray-700">Nombre</label><input name="resp-agente-nombre" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Apellido</label><input name="resp-agente-apellido" type="text" class="${commonInputClasses}"></div><div><label class="text-sm font-medium text-gray-700">Número de DNI</label><input name="resp-agente-dni" type="text" class="${commonInputClasses}"></div>`; break;
                    }
                    fieldsDiv.innerHTML = html;
                });
             });
        }
        
        function getResponsableData(form) {
            const tipoSecuestro = form.querySelector('input[name="tipoSecuestro"]:checked').value;
            if (tipoSecuestro === 'SIN RESPONSABLE') {
                const obsTextarea = document.getElementById('sin-responsable-obs');
                return { tipo: 'Ninguno', observaciones: obsTextarea ? obsTextarea.value || '' : '' };
            }
            const tipoResponsableRadio = form.querySelector('input[name="tipoResponsable"]:checked');
            if (!tipoResponsableRadio) { return { tipo: null }; }
            const tipo = tipoResponsableRadio.value;
            const data = { tipo };
            const fieldsDiv = document.getElementById('responsable-specific-fields');
            if (fieldsDiv) { fieldsDiv.querySelectorAll('input').forEach(input => { data[input.name] = input.value || ''; }); }
            return data;
        }

        // --- VISTAS DE RESUMEN Y DATOS ---
        function renderSummaryView(container) {
             container.innerHTML = `<h2 class="text-3xl font-bold text-inst-dark mb-6">Resumen de Secuestros</h2><div class="p-4 bg-white rounded-xl shadow-lg border mb-6"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div><label for="filter-start-date" class="text-sm font-medium mb-1">Desde:</label><input type="date" id="filter-start-date" class="border-gray-300 rounded-lg py-1.5 px-2 text-sm w-full"></div><div><label for="filter-end-date" class="text-sm font-medium mb-1">Hasta:</label><input type="date" id="filter-end-date" class="border-gray-300 rounded-lg py-1.5 px-2 text-sm w-full"></div><div><label for="filter-organo" class="text-sm font-medium mb-1">Órgano:</label><select id="filter-organo" class="border-gray-300 rounded-lg py-1.5 px-2 text-sm w-full"><option value="todos">Todos</option>${ORGANOS.map(o => `<option value="${o}">${o}</option>`).join('')}</select></div><div class="relative" id="sector-filter-container"><label class="text-sm font-medium mb-1">Sector/Lugar:</label><button id="sector-filter-btn" type="button" class="inline-flex justify-between w-full rounded-md border border-gray-300 px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"><span id="sector-filter-text">Todos los sectores</span><i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5 my-auto"></i></button><div id="sector-filter-options" class="origin-top-right absolute right-0 mt-2 w-72 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10"><div class="py-1 max-h-60 overflow-y-auto">${SECTORES.map(sector => `<label class="flex items-center space-x-3 px-3 py-2 hover:bg-gray-100 cursor-pointer"><input type="checkbox" class="h-4 w-4 text-accent-600 border-gray-300 rounded" value="${sector}"><span class="text-sm text-gray-700">${sector}</span></label>`).join('')}</div></div></div><div><label for="filter-tipo-secuestro" class="text-sm font-medium mb-1">Hallazgo:</label><select id="filter-tipo-secuestro" class="border-gray-300 rounded-lg py-1.5 px-2 text-sm w-full"><option value="todos">Todos</option><option value="CON RESPONSABLE">Con Responsable</option><option value="SIN RESPONSABLE">Sin Responsable</option></select></div><div id="container-tipo-responsable" class="hidden"><label for="filter-tipo-responsable" class="text-sm font-medium mb-1">Tipo Responsable:</label><select id="filter-tipo-responsable" class="border-gray-300 rounded-lg py-1.5 px-2 text-sm w-full"><option value="todos">Todos</option><option value="interno">Interno</option><option value="visita">Visita</option><option value="agente">Agente</option></select></div><div class="lg:col-start-4"><button id="apply-filter-btn" class="w-full px-4 py-2 text-sm font-bold text-white bg-accent-600 rounded-lg hover:bg-accent-700">Filtrar</button></div></div></div><div class="bg-white rounded-xl shadow-lg border overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-4 py-3">Fecha</th><th class="px-4 py-3">Sector</th><th class="px-4 py-3">Órgano</th><th class="px-4 py-3">Detalle</th><th class="px-4 py-3">Tipo Act.</th><th class="px-4 py-3">N° Act.</th><th class="px-4 py-3">Autoridad</th><th class="px-4 py-3 text-center">Acciones</th></tr></thead><tbody id="summary-table-body"></tbody></table></div>`;
             loadAndDisplaySummaryData();
             setupSummaryFilters();
        }

        function loadAndDisplaySummaryData(filters = {}) {
            let filteredData = allProcedures;
            if (filters.startDate) { const start = new Date(filters.startDate).setHours(0,0,0,0); filteredData = filteredData.filter(p => p.datetime >= start); }
            if (filters.endDate) { const end = new Date(filters.endDate).setHours(23,59,59,999); filteredData = filteredData.filter(p => p.datetime <= end); }
            if (filters.sectors && filters.sectors.length > 0) { filteredData = filteredData.filter(p => filters.sectors.includes(p.sector)); }
            if (filters.organo && filters.organo !== 'todos') { filteredData = filteredData.filter(p => p.organo === filters.organo); }
            if (filters.tipoSecuestro && filters.tipoSecuestro !== 'todos') { filteredData = filteredData.filter(p => p.tipoSecuestro === filters.tipoSecuestro); }
            if (filters.tipoResponsable && filters.tipoResponsable !== 'todos') { filteredData = filteredData.filter(p => p.responsable?.tipo === filters.tipoResponsable); }

            const tableBody = document.getElementById('summary-table-body');
            if (!tableBody) return;
            if (filteredData.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-gray-500">No hay datos para mostrar.</td></tr>`; return; }

            tableBody.innerHTML = filteredData.map(proc => {
                const canModify = currentUser.role !== 'Consultor';
                const canDelete = currentUser.canDeleteProcedures;
                const isPending = !proc.actuaciones;
                const date = proc.datetime.toLocaleDateString('es-AR');
                const itemsSummary = proc.items.map(item => item.subtype).join(', ');
                return `
                    <tr class="hover:bg-gray-50 border-b ${isPending ? 'text-orange-600' : 'text-gray-600'}">
                        <td class="px-4 py-4">${date}</td><td class="px-4 py-4">${proc.sector}</td><td class="px-4 py-4">${proc.organo}</td>
                        <td class="px-4 py-4 text-xs">${itemsSummary}</td><td class="px-4 py-4">${proc.actuaciones?.tipo || 'Pendiente'}</td>
                        <td class="px-4 py-4">${proc.actuaciones?.numero || '-'}</td><td class="px-4 py-4">${proc.actuaciones?.autoridad || '-'}</td>
                        <td class="px-4 py-4 text-center space-x-3">
                            <button onclick="openDetailsModal('${proc.id}')" class="text-blue-600 hover:text-blue-800" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                            ${canModify ? `<button onclick="openActuacionesModal('${proc.id}')" class="text-accent-600 hover:text-accent-800" title="Cargar/Editar Actuaciones"><i class="fas fa-pencil-alt"></i></button>` : ''}
                            ${canDelete ? `<button onclick="handleDeleteProcedure('${proc.id}')" class="text-red-600 hover:text-red-800" title="Eliminar Procedimiento"><i class="fas fa-trash-alt"></i></button>` : ''}
                        </td>
                    </tr>`;
            }).join('');
        }
        
        function getCurrentSummaryFilters() {
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const selectedSectors = Array.from(document.querySelectorAll('#sector-filter-options input:checked')).map(i => i.value);
            const organo = document.getElementById('filter-organo').value;
            const tipoSecuestro = document.getElementById('filter-tipo-secuestro').value;
            const tipoResponsable = document.getElementById('filter-tipo-responsable').value;
            return { startDate, endDate, sectors: selectedSectors, organo, tipoSecuestro, tipoResponsable };
        }
        
        function setupSummaryFilters() {
            const container = document.getElementById('sector-filter-container');
            const btn = document.getElementById('sector-filter-btn');
            const optionsDiv = document.getElementById('sector-filter-options');
            const filterText = document.getElementById('sector-filter-text');

            if (!container || !btn || !optionsDiv) return;

            btn.addEventListener('click', () => optionsDiv.classList.toggle('hidden'));

            const checkboxes = optionsDiv.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const selected = Array.from(checkboxes).filter(i => i.checked).map(i => i.value);
                    if (selected.length === 0) filterText.textContent = 'Todos los sectores';
                    else if (selected.length === 1) filterText.textContent = selected[0];
                    else filterText.textContent = `${selected.length} sectores seleccionados`;
                });
            });
            
            document.getElementById('filter-tipo-secuestro').addEventListener('change', (e) => {
                document.getElementById('container-tipo-responsable').classList.toggle('hidden', e.target.value !== 'CON RESPONSABLE');
                if (e.target.value !== 'CON RESPONSABLE') document.getElementById('filter-tipo-responsable').value = 'todos';
            });
            document.getElementById('apply-filter-btn').addEventListener('click', () => {
                loadAndDisplaySummaryData(getCurrentSummaryFilters());
            });
            document.addEventListener('click', (event) => {
                if (!container.contains(event.target)) optionsDiv.classList.add('hidden');
            });
        }
        
        function renderQuantitativeView(container) {
             container.innerHTML = `
                <h2 class="text-3xl font-bold text-inst-dark mb-6">Resumen Cuantitativo</h2>
                <div class="p-4 bg-white rounded-xl shadow-lg border mb-6 flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2"><label for="quant-filter-start-date" class="text-sm font-medium">Desde:</label><input type="date" id="quant-filter-start-date" class="border-gray-300 rounded-lg py-1 px-2 text-sm shadow-sm"></div>
                    <div class="flex items-center gap-2"><label for="quant-filter-end-date" class="text-sm font-medium">Hasta:</label><input type="date" id="quant-filter-end-date" class="border-gray-300 rounded-lg py-1 px-2 text-sm shadow-sm"></div>
                    <button id="quant-apply-filter-btn" class="px-4 py-2 text-sm font-bold text-white bg-accent-600 rounded-lg hover:bg-accent-700">Filtrar</button>
                </div>
                 <div class="bg-white rounded-xl shadow-lg border overflow-x-auto"><table class="w-full text-sm text-left text-gray-600"><thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0"><tr id="quantitative-table-head"></tr></thead><tbody id="quantitative-table-body" class="divide-y divide-gray-200"></tbody></table></div>`;
             loadQuantitativeData();
             setupQuantitativeFilters();
        }

        function setupQuantitativeFilters() {
            document.getElementById('quant-apply-filter-btn').addEventListener('click', () => {
                const startDate = document.getElementById('quant-filter-start-date').value;
                const endDate = document.getElementById('quant-filter-end-date').value;
                loadQuantitativeData({ startDate, endDate });
            });
        }
        
        function loadQuantitativeData(filters = {}) {
            let dataToProcess = [...allProcedures];
            if (filters.startDate) { const start = new Date(filters.startDate).setHours(0,0,0,0); dataToProcess = dataToProcess.filter(p => p.datetime.getTime() >= start); }
            if (filters.endDate) { const end = new Date(filters.endDate).setHours(23,59,59,999); dataToProcess = dataToProcess.filter(p => p.datetime.getTime() <= end); }

            const head = document.getElementById('quantitative-table-head');
            const body = document.getElementById('quantitative-table-body');
            let headHtml = '<th scope="col" class="px-6 py-3">Elemento</th>';
            SECTORES.forEach(sector => { headHtml += `<th scope="col" class="px-2 py-3 text-center text-xs" title="${sector}">${sector.replace('C.C.N° ', 'C').replace('E.P.N° ', 'E')}</th>`; });
            headHtml += '<th scope="col" class="px-6 py-3 text-center font-bold bg-gray-200">Total</th>';
            head.innerHTML = headHtml;
            const stats = {};
            const allItems = ['COCAINA', 'MARIHUANA', 'PSICOFÁRMACOS', 'ALCOHOL', 'CELULAR', 'CHIPS', 'BATERÍAS', 'CARGADORES', 'CABLES USB', 'AURICULARES', 'PLAQUETA', 'PUNZOCORTANTES', 'OTROS'];
            allItems.forEach(item => { stats[item] = {}; SECTORES.forEach(sector => { stats[item][sector] = 0; }); });
            dataToProcess.forEach(proc => {
                proc.items.forEach(item => {
                    if (stats[item.subtype] && stats[item.subtype][proc.sector] !== undefined) {
                        let value = 0;
                        if(item.details.peso) value = parseFloat(item.details.peso) || 0;
                        else if(item.details.cantidad) value = parseInt(item.details.cantidad, 10) || 1;
                        else if(['OTROS', 'PUNZOCORTANTES', 'CELULAR', 'CHIPS'].includes(item.subtype)) value = 1;
                        stats[item.subtype][proc.sector] += value;
                    }
                });
            });
            let bodyHtml = '';
            allItems.forEach(item => {
                let rowTotal = 0;
                let rowHtml = `<tr class="hover:bg-gray-50"><td class="px-6 py-4 font-medium whitespace-nowrap text-gray-900">${item}</td>`;
                SECTORES.forEach(sector => { const value = stats[item][sector] || 0; rowTotal += value; rowHtml += `<td class="px-2 py-4 text-center">${value > 0 ? value.toFixed(1).replace('.0', '') : '-'}</td>`; });
                rowHtml += `<td class="px-6 py-4 text-center font-bold text-accent-700 bg-gray-100">${rowTotal.toFixed(1).replace('.0', '')}</td></tr>`;
                bodyHtml += rowHtml;
            });
            body.innerHTML = bodyHtml;
        }

        // --- VISTA DE ADMINISTRACION DE USUARIOS ---
        async function renderAdminUsersView(container) {
            const commonInputClasses = "w-full px-3 py-2 mt-1 bg-white border border-gray-300 rounded-lg shadow-sm";
            container.innerHTML = `<h2 class="text-3xl font-bold text-inst-dark mb-4">Administración de Usuarios</h2><div class="space-y-6"><div class="p-6 bg-white rounded-xl shadow-lg border"><h3 class="text-xl font-semibold text-accent-600 mb-4 border-b pb-3">Crear Nuevo Usuario</h3><form id="create-user-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label for="new-user-dni" class="block text-sm font-medium text-gray-700">Usuario (DNI)</label><input type="text" id="new-user-dni" class="${commonInputClasses}" required></div><div><label for="new-user-name" class="block text-sm font-medium text-gray-700">Nombre Completo</label><input type="text" id="new-user-name" class="${commonInputClasses}" required></div><div><label for="new-user-password" class="block text-sm font-medium text-gray-700">Contraseña</label><input type="password" id="new-user-password" class="${commonInputClasses}" required></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="new-user-role" class="block text-sm font-medium text-gray-700">Rol</label><select id="new-user-role" class="${commonInputClasses}" required>${ROLES.map(r => `<option value="${r}">${r}</option>`).join('')}</select></div><div><label class="block text-sm font-medium text-gray-700">Alcances (Sectores)</label><div class="mt-1 p-2 border border-gray-300 rounded-lg bg-white max-h-40 overflow-y-auto grid grid-cols-2 gap-2">${SECTORES.map(s => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" name="scope" value="${s}" class="h-4 w-4 rounded border-gray-300 text-accent-600"><span>${s}</span></label>`).join('')}</div></div></div><div class="pt-2"><label class="flex items-center space-x-2 text-sm font-medium text-gray-700"><input type="checkbox" id="new-user-can-delete" class="h-4 w-4 rounded border-gray-300 text-accent-600"><span>Puede eliminar procedimientos</span></label></div><div class="text-right pt-2"><button type="submit" class="px-5 py-2 font-bold text-white bg-green-600 rounded-lg hover:bg-green-700"><i class="fas fa-plus-circle mr-2"></i>Crear Usuario</button></div></form></div><div class="p-6 bg-white rounded-xl shadow-lg border"><h3 class="text-xl font-semibold text-accent-600 mb-4 border-b pb-3">Usuarios Existentes</h3><div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-100"><tr><th class="px-6 py-3">Nombre</th><th class="px-6 py-3">Rol</th><th class="px-6 py-3">Estado</th><th class="px-6 py-3 text-center">Acciones</th></tr></thead><tbody id="users-table-body"></tbody></table></div></div></div>`;
            await renderUsersTable();
            document.getElementById('create-user-form').addEventListener('submit', handleCreateUser);
        }
        
        async function renderUsersTable() {
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>`;
            try {
                const querySnapshot = await getDocs(collection(db, "users"));
                const usersHtml = querySnapshot.docs.map(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    if (user.id === currentUser.id) return ''; // Admin no se puede editar a sí mismo
                    const statusClass = user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const toggleIcon = user.active ? 'fa-toggle-on text-green-600' : 'fa-toggle-off text-gray-400';
                    const toggleTitle = user.active ? 'Desactivar' : 'Activar';
                    return `<tr class="hover:bg-gray-50 border-b">
                        <td class="px-6 py-4 font-medium text-gray-900">${user.name}<br><span class="text-xs text-gray-500">${user.dni}</span></td>
                        <td class="px-6 py-4">${user.role}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">${user.active ? 'Activo' : 'Inactivo'}</span></td>
                        <td class="px-6 py-4 text-center space-x-4">
                            <button onclick="openEditUserModal('${user.id}')" class="text-blue-600 hover:text-blue-800" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="handleToggleUserStatus('${user.id}', ${user.active})" class="text-xl" title="${toggleTitle} Usuario"><i class="fas ${toggleIcon}"></i></button>
                            <button onclick="handleResetPassword('${user.dni}')" class="text-yellow-600 hover:text-yellow-800" title="Blanquear Contraseña"><i class="fas fa-key"></i></button>
                        </td>
                    </tr>`;
                }).join('');
                tableBody.innerHTML = usersHtml || `<tr><td colspan="4" class="text-center p-4">No hay otros usuarios para mostrar.</td></tr>`;
            } catch (error) {
                console.error("Error fetching users:", error);
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Error al cargar usuarios.</td></tr>`;
            }
        }

        async function handleCreateUser(e) {
            e.preventDefault();
            const form = e.target;
            const dni = form.querySelector('#new-user-dni').value;
            const password = form.querySelector('#new-user-password').value;
            const email = `${dni}@trazabilidad.app`;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userData = {
                    dni,
                    name: form.querySelector('#new-user-name').value,
                    role: form.querySelector('#new-user-role').value,
                    scope: Array.from(form.querySelectorAll('input[name="scope"]:checked')).map(cb => cb.value),
                    canDeleteProcedures: form.querySelector('#new-user-can-delete').checked,
                    active: true
                };
                await setDoc(doc(db, "users", user.uid), userData);
                showMessage('Éxito', `Usuario '${userData.name}' creado correctamente.`);
                await renderUsersTable();
                form.reset();
                // Re-authenticate admin
                const adminEmail = `${currentUser.dni}@trazabilidad.app`;
                const adminPass = prompt("Para continuar, por favor reingrese su contraseña de administrador:");
                if (adminPass) { await signInWithEmailAndPassword(auth, adminEmail, adminPass); } else { handleLogout(); }
            } catch (error) {
                console.error("Error creando usuario:", error);
                if (error.code == 'auth/email-already-in-use') showMessage('Error', `El DNI '${dni}' ya existe.`);
                else if (error.code == 'auth/weak-password') showMessage('Error', 'La contraseña debe tener al menos 6 caracteres.');
                else showMessage('Error', 'No se pudo crear el usuario.');
            }
        }
        
        async function openEditUserModal(userId) {
            try {
                const userRef = doc(db, "users", userId);
                const userDoc = await getDoc(userRef);
                if (!userDoc.exists()) { showMessage("Error", "Usuario no encontrado."); return; }
                const user = userDoc.data();
                
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-user-dni').value = user.dni;
                document.getElementById('edit-user-name').value = user.name;
                
                const roleSelect = document.getElementById('edit-user-role');
                roleSelect.innerHTML = ROLES.map(r => `<option value="${r}" ${user.role === r ? 'selected' : ''}>${r}</option>`).join('');
                
                const scopeDiv = document.getElementById('edit-user-scope');
                scopeDiv.innerHTML = SECTORES.map(s => `<label class="flex items-center space-x-2 text-sm"><input type="checkbox" name="edit-scope" value="${s}" class="h-4 w-4 rounded border-gray-300 text-accent-600" ${user.scope.includes(s) ? 'checked' : ''}><span>${s}</span></label>`).join('');
                
                document.getElementById('edit-user-can-delete').checked = user.canDeleteProcedures || false;

                document.getElementById('edit-user-modal').classList.add('hidden');
                document.getElementById('edit-user-modal').classList.add('flex');
            } catch (error) {
                console.error("Error abriendo modal de edición:", error);
                showMessage("Error", "No se pudieron cargar los datos del usuario.");
            }
        }
        
        async function handleUpdateUser(e) {
            e.preventDefault();
            const userId = document.getElementById('edit-user-id').value;
            const userRef = doc(db, "users", userId);
            try {
                const updatedData = {
                    name: document.getElementById('edit-user-name').value,
                    role: document.getElementById('edit-user-role').value,
                    scope: Array.from(document.querySelectorAll('input[name="edit-scope"]:checked')).map(cb => cb.value),
                    canDeleteProcedures: document.getElementById('edit-user-can-delete').checked
                };
                await updateDoc(userRef, updatedData);
                showMessage("Éxito", "Usuario actualizado correctamente.");
                document.getElementById('edit-user-modal').classList.add('hidden');
                document.getElementById('edit-user-modal').classList.remove('flex');
                renderUsersTable();
            } catch (error) {
                console.error("Error actualizando usuario:", error);
                showMessage("Error", "No se pudo actualizar el usuario.");
            }
        }
        
        async function handleToggleUserStatus(userId, currentStatus) {
            const action = currentStatus ? "desactivar" : "activar";
            showConfirm(`Confirmar ${action}`, `¿Está seguro de que desea ${action} a este usuario?`, async () => {
                try {
                    await updateDoc(doc(db, "users", userId), { active: !currentStatus });
                    showMessage("Éxito", `Usuario ${action}do correctamente.`);
                    renderUsersTable();
                } catch (error) {
                    console.error(`Error al ${action} usuario:`, error);
                    showMessage("Error", `No se pudo ${action} al usuario.`);
                }
            });
        }

        function handleResetPassword(dni) {
            const email = `${dni}@trazabilidad.app`;
            showConfirm(
                'Blanquear Contraseña',
                `Se enviará un correo para restablecer la contraseña a la dirección asociada con el DNI ${dni}. ¿Continuar?`,
                async () => {
                    try {
                        await sendPasswordResetEmail(auth, email); 
                        showMessage('Correo Enviado', `Se ha enviado un correo para restablecer la contraseña a ${email}.`);
                    } catch (error) {
                        console.error("Error reseteando pass:", error);
                        showMessage("Error", "No se pudo iniciar el proceso de reseteo. Verifique que el usuario exista.");
                    }
                }
            );
        }
        
        function openActuacionesModal(procId) {
            const proc = allProcedures.find(p => p.id === procId);
            if (!proc) return;
            const form = document.getElementById('actuaciones-form');
            form.reset();
            document.getElementById('autoridad-container').classList.add('hidden');
            document.getElementById('actuaciones-proc-id').value = procId;
            document.getElementById('actuaciones-archivo-info').textContent = '';
            if (proc.actuaciones) {
                document.getElementById('actuaciones-tipo').value = proc.actuaciones.tipo || '';
                document.getElementById('actuaciones-numero').value = proc.actuaciones.numero || '';
                if (proc.actuaciones.tipo === 'SAC') {
                     document.getElementById('autoridad-container').classList.remove('hidden');
                     document.getElementById('actuaciones-autoridad').value = proc.actuaciones.autoridad || '';
                }
                if (proc.actuaciones.fileName) {
                    document.getElementById('actuaciones-archivo-info').textContent = `Archivo actual: ${proc.actuaciones.fileName}. Seleccionar uno nuevo lo reemplazará.`;
                }
            }
            document.getElementById('actuaciones-modal').classList.remove('hidden');
            document.getElementById('actuaciones-modal').classList.add('flex');
        }
        
        function openDetailsModal(procId) {
            const proc = allProcedures.find(p => p.id === procId);
            if (!proc) return;
            const contentDiv = document.getElementById('details-content');
            
            let detailsHtml = `<div class="p-4 border rounded-lg bg-gray-50"><h4 class="text-lg font-semibold text-accent-700 mb-3 border-b pb-2">Datos del Hecho</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"><div><strong class="text-gray-500 block">Fecha:</strong> <span class="text-gray-800">${proc.datetime.toLocaleDateString('es-AR')}</span></div><div><strong class="text-gray-500 block">Sector:</strong> <span class="text-gray-800">${proc.sector}</span></div><div><strong class="text-gray-500 block">Órgano Actuante:</strong> <span class="text-gray-800">${proc.organo}</span></div><div><strong class="text-gray-500 block">Registrado por:</strong> <span class="text-gray-800">${proc.createdByName}</span></div></div></div>`;
            
            let responsableHtml = '';
            if (proc.tipoSecuestro === 'SIN RESPONSABLE') { responsableHtml = `<p>Hallazgo sin responsable.</p><p class="mt-1 text-gray-600 text-sm"><strong>Observaciones:</strong> ${proc.responsable.observaciones || 'Ninguna'}</p>`;
            } else { responsableHtml = Object.entries(proc.responsable).map(([key, value]) => { if (!value) return ''; return `<div><strong class="text-gray-500 block capitalize">${key.replace('resp-','').replace('-',' ')}:</strong> <span class="text-gray-800">${value}</span></div>`; }).join(''); }
            detailsHtml += `<div class="p-4 border rounded-lg bg-gray-50"><h4 class="text-lg font-semibold text-accent-700 mb-3 border-b pb-2">Responsable</h4><div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">${responsableHtml}</div></div>`;
            
            let itemsHtml = proc.items.map(item => {
                 let itemDetails = Object.entries(item.details).map(([key, value]) => { const fieldConfig = ELEMENTOS_CONFIG[item.type][item.subtype].find(f => f.name === key); if (!value) return ''; return `<li class="text-xs"><strong class="font-medium text-gray-600">${fieldConfig.label}:</strong> ${value === true ? 'Sí' : value}</li>`; }).join('');
                 if(item.observaciones) { itemDetails += `<li class="text-xs"><strong class="font-medium text-gray-600">Obs:</strong> ${item.observaciones}</li>`; }
                 return `<div class="p-3 border rounded-md bg-white"><p class="font-bold text-gray-800">${item.subtype} <span class="text-gray-500 font-normal">(${item.type})</span></p><ul class="list-disc list-inside ml-2 mt-1 space-y-1">${itemDetails}</ul></div>`;
            }).join('');
            detailsHtml += `<div class="p-4 border rounded-lg bg-gray-50"><h4 class="text-lg font-semibold text-accent-700 mb-3 border-b pb-2">Elementos Secuestrados</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">${itemsHtml}</div></div>`;
            
            let actuacionesHtml = '';
            if (proc.actuaciones) {
                 actuacionesHtml = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"><div><strong class="text-gray-500 block">Tipo:</strong> <span class="text-gray-800">${proc.actuaciones.tipo}</span></div><div><strong class="text-gray-500 block">Número:</strong> <span class="text-gray-800">${proc.actuaciones.numero}</span></div>${proc.actuaciones.autoridad ? `<div><strong class="text-gray-500 block">Autoridad:</strong> <span class="text-gray-800">${proc.actuaciones.autoridad}</span></div>` : ''}</div>`;
                 if (proc.actuaciones.fileURL) {
                    actuacionesHtml += `<div class="mt-4 border-t pt-4"><p class="text-sm font-semibold text-gray-700 mb-2">Archivo Adjunto</p><a href="${proc.actuaciones.fileURL}" target="_blank" rel="noopener noreferrer" class="border-2 border-dashed rounded-lg p-4 text-center bg-white block hover:bg-gray-50"><i class="far fa-file-pdf fa-3x text-red-500 mb-2"></i><p class="font-semibold text-gray-800">${proc.actuaciones.fileName}</p><p class="text-xs text-blue-600 mt-1 underline">Ver Archivo</p></a></div>`;
                 }
            } else { actuacionesHtml = `<p class="text-sm text-gray-500">Aún no se han cargado actuaciones.</p>`; }
            detailsHtml += `<div class="p-4 border rounded-lg bg-gray-50"><h4 class="text-lg font-semibold text-accent-700 mb-3 border-b pb-2">Actuaciones</h4>${actuacionesHtml}</div>`;

            contentDiv.innerHTML = detailsHtml;
            document.getElementById('procedure-details-modal').classList.remove('hidden');
            document.getElementById('procedure-details-modal').classList.add('flex');
        }

        function initApp() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('actuaciones-form').addEventListener('submit', handleSaveActuaciones);
            document.getElementById('edit-user-form').addEventListener('submit', handleUpdateUser);
            document.getElementById('actuaciones-modal-cancel').addEventListener('click', () => { document.getElementById('actuaciones-modal').classList.add('hidden'); document.getElementById('actuaciones-modal').classList.remove('flex'); });
            document.getElementById('edit-user-modal-cancel').addEventListener('click', () => { document.getElementById('edit-user-modal').classList.add('hidden'); document.getElementById('edit-user-modal').classList.remove('flex'); });
            document.getElementById('actuaciones-tipo').addEventListener('change', (e) => document.getElementById('autoridad-container').classList.toggle('hidden', e.target.value !== 'SAC'));
            ['details-modal-close', 'details-modal-close-btn'].forEach(id => { document.getElementById(id).addEventListener('click', () => { document.getElementById('procedure-details-modal').classList.add('hidden'); document.getElementById('procedure-details-modal').classList.remove('flex'); }); });
        }
        
        // Inicializar la aplicación
        initApp();

    </script>
</body>
</html>

